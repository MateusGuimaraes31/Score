{% extends "base.html" %}

{% block title %}{{ community.name }} - SCORE{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/community.css') }}">
{% endblock %}

{% block content %}
<div class="container community-page">
    <div class="community-info-section">
        <div class="community-header">
            <div class="game-info">
                <img src="{{ community.game_img }}" alt="{{ community.game_name }}" class="game-image">
                <div class="game-details">
                    <h1>{{ community.name }}</h1>
                    <p>Comunidade para <a href="{{ url_for('game_details', appid=community.game_id) }}" class="community-game-link">{{ community.game_name }}</a></p>
                    <p class="text-muted">Criada em {{ community.created_at.strftime('%d/%m/%Y') }}</p>
                    <p class="community-description-text mb-0">{{ community.description }}</p>
                </div>
            </div>
        </div>
    </div>

    {% if is_member %}
        <div class="post-form">
            <form action="{{ url_for('create_post', community_id=community.id) }}" method="post" enctype="multipart/form-data" id="postForm">
                <div class="mb-3">
                    <textarea class="form-control" name="content" rows="3" placeholder="Compartilhe algo com a comunidade..." required></textarea>
                </div>
                <div class="mb-3">
                    <div class="media-upload-container">
                        <input type="file" class="form-control" id="media" name="media" accept="image/*,video/*" style="display: none;">
                        <div class="media-upload-preview" id="mediaPreview" style="display: none;">
                            <div class="preview-container">
                                <img id="imagePreview" src="" alt="Prévia da imagem" style="display: none; max-width: 100%; max-height: 300px;">
                                <video id="videoPreview" src="" controls style="display: none; max-width: 100%; max-height: 300px;"></video>
                                <button type="button" class="btn btn-danger btn-sm remove-media" id="removeMedia">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <button type="button" class="btn btn-outline-primary" id="selectMedia">
                            <i class="fas fa-image"></i> Adicionar Mídia
                        </button>
                    </div>
                </div>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-paper-plane"></i> Publicar
                </button>
            </form>
        </div>
    {% else %}
        <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i> Você precisa ser membro para postar nesta comunidade.
            <form action="{{ url_for('join_community', community_id=community.id) }}" method="post" class="mt-2">
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-user-plus"></i> Entrar na Comunidade
                </button>
            </form>
        </div>
    {% endif %}

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4>Postagens</h4>
        <div>
            Ordenar por:
            <a href="{{ url_for('community_details', community_id=community.id, sort='recent', page=posts.page) }}" class="btn btn-sm {% if sort_by == 'recent' %}btn-primary{% else %}btn-outline-secondary{% endif %}">Mais Recentes</a>
            <a href="{{ url_for('community_details', community_id=community.id, sort='popular', page=posts.page) }}" class="btn btn-sm {% if sort_by == 'popular' %}btn-primary{% else %}btn-outline-secondary{% endif %}">Mais Populares</a>
        </div>
    </div>

    <div class="posts">
        {% for post in posts.items %}
            <div class="post-card">
                <div class="post-header">
                    <img src="{{ url_for('static', filename=post.author.avatar_url) }}" alt="{{ post.author.username }}" class="post-author-avatar">
                    <div>
                        <h5 class="post-author-name" data-post-author-id="{{ post.user_id }}" data-community-creator-id="{{ community.creator_id }}">
                            <a href="{{ url_for('profile', username=post.author.username) }}">{{ post.author.username }}</a>
                            {% if post.author.id == community.creator_id %}
                                <span class="community-leader"><i class="fas fa-crown"></i> Líder</span>
                            {% endif %}
                        </h5>
                        <small class="text-muted">{{ post.created_at.strftime('%d/%m/%Y %H:%M') }}</small>
                    </div>
                </div>
                <div class="post-content">
                    {{ post.content }}
                </div>
                {% if post.media_url %}
                    <div class="post-media-container">
                        {% if post.media_type == 'image' %}
                        <a href="#" class="media-link" data-media-url="{{ url_for('static', filename=post.media_url) }}" data-media-type="image">
                            <img src="{{ url_for('static', filename=post.media_url) }}" alt="Post media" class="post-media img-fluid">
                        </a>
                        {% elif post.media_type == 'video' %}
                         <a href="#" class="media-link" data-media-url="{{ url_for('static', filename=post.media_url) }}" data-media-type="video">
                            <video controls class="post-media img-fluid">
                                <source src="{{ url_for('static', filename=post.media_url) }}" type="video/{{ post.media_url.rsplit('.', 1)[1] }}">
                                Seu navegador não suporta a tag de vídeo.
                            </video>
                         </a>
                        {% endif %}
                    </div>
                {% endif %}
                <div class="post-actions">
                    <form action="{{ url_for('like_post', post_id=post.id) }}" method="post" class="d-inline">
                        <button type="submit" class="post-action-btn">
                            <i class="fas fa-thumbs-up"></i> Curtir ({{ post.likes }})
                        </button>
                    </form>
                    {% if current_user.is_authenticated and (current_user.id == post.user_id or current_user.id == community.creator_id) %}
                    <form action="{{ url_for('delete_post', post_id=post.id) }}" method="post" class="d-inline delete-form" data-post-id="{{ post.id }}">
                        <button type="submit" class="btn btn-danger btn-sm ms-2 delete-post-btn">
                            <i class="fas fa-trash-alt"></i> Apagar
                        </button>
                    </form>
                    {% endif %}
                </div>
                <div class="comments-section">
                    <h6 class="mb-3">Comentários</h6>
                    {% if is_member %}
                        <form action="{{ url_for('add_comment', post_id=post.id) }}" method="post" class="comment-form">
                            <textarea name="comment" rows="4" placeholder="Adicionar um comentário..." class="form-control"></textarea>
                            <button type="submit" class="btn btn-primary btn-sm">Comentar</button>
                        </form>
                    {% endif %}
                    {% for comment in post.comments %}
                        <div class="comment" data-comment-author-id="{{ comment.user_id }}">
                            <div class="comment-author d-flex align-items-center mb-2">
                                <div class="author-info">
                                    <a href="{{ url_for('profile', username=comment.author.username) }}" class="author-name">
                                        <img src="{{ url_for('static', filename=comment.author.avatar_url) }}" alt="{{ comment.author.username }}" class="author-avatar">
                                        {{ comment.author.username }}
                                    </a>
                                </div>
                            </div>
                            <div class="comment-content">
                                {{ comment.content }}
                            </div>
                            <small class="text-muted">{{ comment.created_at.strftime('%d/%m/%Y %H:%M') }}</small>
                            {% if current_user.is_authenticated and current_user.id == comment.user_id %}
                            <form action="{{ url_for('delete_comment', comment_id=comment.id) }}" method="post" class="d-inline delete-form">
                                <button type="submit" class="btn btn-danger btn-sm ms-2 delete-comment-btn">
                                    <i class="fas fa-trash-alt"></i> Apagar
                                </button>
                            </form>
                            {% endif %}
                        </div>
                    {% else %}
                        <p class="text-muted">Nenhum comentário ainda.</p>
                    {% endfor %}
                </div>
            </div>
        {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i> Nenhuma postagem ainda. Seja o primeiro a compartilhar algo!
            </div>
        {% endfor %}
    </div>

    {# Links de Paginação #}
    <nav aria-label="Navegação de páginas">
        <ul class="pagination justify-content-center">
            {% for page_num in posts.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                {% if page_num %}
                    {% if posts.page == page_num %}
                        <li class="page-item active" aria-current="page">
                            <a class="page-link" href="{{ url_for('community_details', community_id=community.id, page=page_num, sort=sort_by) }}">{{ page_num }}</a>
                        </li>
                    {% else %}
                        <li class="page-item">
                            <a class="page-link" href="{{ url_for('community_details', community_id=community.id, page=page_num, sort=sort_by) }}">{{ page_num }}</a>
                        </li>
                    {% endif %}
                {% else %}
                    <li class="page-item disabled">
                        <a class="page-link" href="#">...</a>
                    </li>
                {% endif %}
            {% endfor %}
        </ul>
    </nav>

</div>

{# Modal para Visualização de Mídia #}
<div class="modal fade" id="mediaModal" tabindex="-1" aria-labelledby="mediaModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="mediaModalLabel">Visualizar Mídia</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <img id="modalImage" src="" alt="Mídia do Post" class="img-fluid" style="display: none;">
                <video id="modalVideo" src="" controls class="img-fluid" style="display: none;"></video>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    console.log('Script community_details.html carregado.'); // Log inicial

    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOMContentLoaded disparado.'); // Log quando o DOM estiver pronto

        const mediaInput = document.getElementById('media');
        const selectMediaBtn = document.getElementById('selectMedia');
        const mediaPreview = document.getElementById('mediaPreview');
        const imagePreview = document.getElementById('imagePreview');
        const videoPreview = document.getElementById('videoPreview');
        const removeMediaBtn = document.getElementById('removeMedia');
        const postForm = document.getElementById('postForm');

        // Elementos da modal de mídia
        const mediaModal = new bootstrap.Modal(document.getElementById('mediaModal'));
        const modalImage = document.getElementById('modalImage');
        const modalVideo = document.getElementById('modalVideo');

        if (!mediaInput) {
            console.error('Elemento #media (input de arquivo) NÃO encontrado!');
        }
        if (!selectMediaBtn) {
            console.error('Elemento #selectMedia (botão de adicionar mídia) NÃO encontrado!');
        }
        if (!mediaPreview) {
            console.error('Elemento #mediaPreview (container de prévia) NÃO encontrado!');
        }
        if (!imagePreview) {
             console.error('Elemento #imagePreview (prévia de imagem) NÃO encontrado!');
        }
         if (!videoPreview) {
            console.error('Elemento #videoPreview (prévia de vídeo) NÃO encontrado!');
        }
        if (!removeMediaBtn) {
            console.error('Elemento #removeMedia (botão de remover mídia) NÃO encontrado!');
        }
        if (!postForm) {
             console.error('Elemento #postForm (formulário de postagem) NÃO encontrado!');
        }
        if (!mediaModal) {
             console.error('Objeto bootstrap.Modal para #mediaModal NÃO criado!');
        }
         if (!modalImage) {
            console.error('Elemento #modalImage NÃO encontrado!');
        }
        if (!modalVideo) {
            console.error('Elemento #modalVideo NÃO encontrado!');
        }


        if (mediaInput && selectMediaBtn && mediaPreview && imagePreview && videoPreview && removeMediaBtn && mediaModal && modalImage && modalVideo) {
            console.log('Todos os elementos essenciais de upload e visualização de mídia encontrados.'); // Log se todos os elementos essenciais forem encontrados

            // Função para mostrar o seletor de arquivo
            selectMediaBtn.addEventListener('click', () => {
                console.log('Botão #selectMedia clicado.'); // Log ao clicar no botão
                mediaInput.click(); // Aciona o input de arquivo oculto
                console.log('mediaInput.click() chamado.'); // Log após chamar o click
            });

            // Função para lidar com a seleção de arquivo
            mediaInput.addEventListener('change', function(e) {
                console.log('Evento change no #mediaInput disparado.'); // Log ao selecionar um arquivo
                const file = e.target.files[0];
                if (!file) {
                    console.log('Nenhum arquivo selecionado (cancelado?).'); // Log se nenhum arquivo for selecionado
                    // Limpa a prévia se nenhum arquivo for selecionado
                    imagePreview.src = '';
                    videoPreview.src = '';
                    mediaPreview.style.display = 'none';
                    return;
                }

                console.log('Arquivo selecionado:', file.name, 'Tipo:', file.type); // Log do arquivo selecionado

                // Verifica o tipo do arquivo
                if (!file.type.startsWith('image/') && !file.type.startsWith('video/')) {
                    console.log('Tipo de arquivo não suportado selecionado.');
                    alert('Por favor, selecione apenas imagens ou vídeos.');
                    mediaInput.value = ''; // Limpa o input para permitir nova seleção
                    // Oculta a prévia também
                    imagePreview.src = '';
                    videoPreview.src = '';
                    mediaPreview.style.display = 'none';
                    return;
                }

                // Cria um objeto URL para o arquivo
                const fileURL = URL.createObjectURL(file);
                console.log('URL do objeto criada:', fileURL); // Log da URL do objeto

                // Mostra a prévia apropriada
                if (file.type.startsWith('image/')) {
                    console.log('Exibindo prévia de imagem.');
                    imagePreview.src = fileURL;
                    imagePreview.style.display = 'block';
                    videoPreview.style.display = 'none';
                    videoPreview.src = ''; // Limpa o src do vídeo
                } else { // Assume que é vídeo se não for imagem (depois da validação inicial)
                     console.log('Exibindo prévia de vídeo.');
                    videoPreview.src = fileURL;
                    videoPreview.style.display = 'block';
                    imagePreview.style.display = 'none';
                    imagePreview.src = ''; // Limpa o src da imagem
                }

                // Mostra o container de prévia
                mediaPreview.style.display = 'block';
            });

            // Função para remover a mídia selecionada
            removeMediaBtn.addEventListener('click', () => {
                console.log('Botão #removeMedia clicado. Removendo mídia.'); // Log ao remover
                mediaInput.value = ''; // Limpa o valor do input file
                imagePreview.src = ''; // Limpa o src da imagem
                videoPreview.src = ''; // Limpa o src do vídeo
                mediaPreview.style.display = 'none';
                console.log('Prévia de mídia limpa.');
            });

             // Confirmação para apagar postagens (mantido do código original)
            document.querySelectorAll('.delete-post-btn').forEach(button => {
                button.addEventListener('click', function(e) {
                    if (!confirm('Tem certeza que deseja apagar esta postagem?')) {
                        e.preventDefault();
                    }
                });
            });

            // Confirmação para apagar comentários (mantido do código original)
            document.querySelectorAll('.delete-comment-btn').forEach(button => {
                button.addEventListener('click', function(e) {
                    if (!confirm('Tem certeza que deseja apagar este comentário?')) {
                        e.preventDefault();
                    }
                });
            });

            // --- Funcionalidade de Modal para Visualização de Mídia --- //
            document.querySelectorAll('.media-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault(); // Impede o redirecionamento
                    const mediaUrl = this.dataset.mediaUrl;
                    const mediaType = this.dataset.mediaType;

                    console.log('Link de mídia clicado. URL:', mediaUrl, 'Tipo:', mediaType); // Log ao clicar

                    // Oculta ambos primeiro
                    modalImage.style.display = 'none';
                    modalVideo.style.display = 'none';
                    modalImage.src = ''; // Limpa src anterior
                    modalVideo.src = ''; // Limpa src anterior

                    if (mediaType === 'image') {
                        modalImage.src = mediaUrl;
                        modalImage.style.display = 'block';
                         console.log('Modal definida para imagem.');
                    } else if (mediaType === 'video') {
                        modalVideo.src = mediaUrl;
                        modalVideo.style.display = 'block';
                         console.log('Modal definida para vídeo.');
                    }

                    mediaModal.show(); // Mostra a modal
                    console.log('Modal de mídia exibida.');
                });
            });

        } else {
             console.error('Um ou mais elementos essenciais de upload/visualização de mídia NÃO foram encontrados. Funcionalidade pode estar limitada.');
        }
    });

    // Confirmação para apagar comunidade (para o criador)
    document.querySelectorAll('.delete-community-button').forEach(button => {
        button.addEventListener('click', function() {
            if (confirm('Tem certeza que deseja apagar esta comunidade? Esta ação é irreversível.')) {
                this.closest('form').submit();
            }
        });
    });

</script>
{% endblock %} 